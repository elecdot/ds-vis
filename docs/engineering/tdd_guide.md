---
bound_phase: P0.3
version: v1.1
status: Active
last_updated: 2025-12-15
---

# TDD Guide â€” æµ‹è¯•é©±åŠ¨å¼€å‘æŒ‡å—

> **æ–°äººå³ç”¨**ï¼šæ— é¡»é¢å¤–æç¤ºï¼Œé»˜è®¤æ‰€æœ‰æ”¹åŠ¨èµ° TDDã€‚å…ˆå†™ï¼ˆæˆ–æ›´æ–°ï¼‰æµ‹è¯•ï¼Œå†å®ç°ï¼Œå†é‡æ„ï¼Œä¿æŒ CI å‘½ä»¤é€šè¿‡ï¼ˆå‚è§ `.github/pull_request_template.md`ï¼‰ã€‚
> **åŸåˆ™**: "No Production Code Without a Failing Test."

æœ¬é¡¹ç›®å¼ºåˆ¶é‡‡ç”¨ **TDD (Test-Driven Development)**ï¼š
- ä¿éšœå¤æ‚åˆ†å±‚ï¼ˆModel â†’ Layout â†’ Renderer â†’ UIï¼‰ä¸‹çš„è¡Œä¸ºå¯è¯ã€‚
- å°†éœ€æ±‚è½åœ¨â€œå¯æ‰§è¡Œçš„è§„æ ¼â€ä¸Šï¼šæ–°å¢åŠŸèƒ½=æ–°å¢/æ›´æ–°æµ‹è¯•ã€‚
ä»…å½“æ–‡æ¡£(è§ä¸‹æ–‡)æ˜ç¡®è±å…æ—¶ï¼ˆä¾‹å¦‚ä¸€æ¬¡æ€§è„šæ‰‹æ¶ã€å¤–éƒ¨ä¾èµ–éš¾ä»¥ mockï¼‰ï¼Œæ‰å¯æš‚ç¼“ï¼Œä½†ä»éœ€ç•™ä¸‹ `xfail` æˆ– TODO è¯´æ˜ã€‚

---

## 1. TDD æ ¸å¿ƒå¾ªç¯ (The Loop)

æˆ‘ä»¬åœ¨æ ‡å‡† Red-Green-Refactor çš„åŸºç¡€ä¸Šï¼Œç»“åˆæœ¬é¡¹ç›®çš„ `xfail` å®è·µï¼Œå®šä¹‰äº†ä»¥ä¸‹å·¥ä½œæµï¼š

### ğŸ”´ Phase 1: Red (ç¼–å†™å¤±è´¥çš„æµ‹è¯•)

1. **æ˜ç¡®ç›®æ ‡**: ä½ è¦å®ç°ä»€ä¹ˆåŠŸèƒ½ï¼Ÿï¼ˆä¾‹å¦‚ï¼šBST æ—‹è½¬ã€åŒå‘é“¾è¡¨åˆ é™¤ï¼‰ã€‚
2. **å®šä½æµ‹è¯•æ–‡ä»¶**:
   - **çº¯é€»è¾‘** (Model/Layout): åœ¨ `tests/core/` ä¸‹æ–°å»ºæˆ–ä¿®æ”¹ã€‚
   - **æ¸²æŸ“/è§†è§‰** (Renderer): åœ¨ `tests/renderers/` ä¸‹æ–°å»ºæˆ–ä¿®æ”¹ã€‚
   - **é›†æˆ/å†’çƒŸ** (UI/Flow): åœ¨ `tests/ui/` æˆ– `tests/core/test_scene_graph_flow.py`ã€‚
3. **ç¼–å†™æµ‹è¯•ç”¨ä¾‹**:
   - æ¨¡æ‹Ÿè¾“å…¥ (Command / Ops)ã€‚
   - æ–­è¨€é¢„æœŸè¾“å‡º (Timeline / Node Position / ID Stability)ã€‚
4. **æ ‡è®°ä¸º xfail** (å¯é€‰ä½†æ¨è):
   - å¦‚æœä½ æ‰“ç®—åˆ†æ­¥æäº¤ï¼Œæˆ–è€…è¿™æ˜¯ä¸€ä¸ªå·²çŸ¥ä½†æš‚æœªä¿®å¤çš„ Bugï¼Œä½¿ç”¨ `@pytest.mark.xfail(reason="P0.x: Feature pending")`ã€‚
   - è¿™æ · CI ä¾ç„¶æ˜¯ç»¿çš„ï¼Œä½†æ˜ç¡®è®°å½•äº†â€œæ¬ å€ºâ€ã€‚
5. **è¿è¡Œæµ‹è¯•**: ç¡®è®¤å®ƒç¡®å®**å¤±è´¥**äº†ï¼ˆæˆ–è€… xfail äº†ï¼‰ã€‚
   ```bash
   uv run pytest tests/path/to/your_test.py
   ```

### ğŸŸ¢ Phase 2: Green (è®©æµ‹è¯•é€šè¿‡)

1. **ç¼–å†™æœ€å°å®ç°**:
   - ä¸è¦è¿‡åº¦è®¾è®¡ã€‚
   - åªå†™èƒ½è®©æµ‹è¯•é€šè¿‡çš„æœ€å°‘ä»£ç ã€‚
2. **è¿è¡Œæµ‹è¯•**:
   - ç¡®ä¿åˆšæ‰å†™çš„æµ‹è¯•å˜ç»¿ (Passed)ã€‚
   - ç¡®ä¿æ²¡æœ‰ç ´åå…¶ä»–æµ‹è¯• (Regression Check)ã€‚
3. **ç§»é™¤ xfail**: å¦‚æœä¹‹å‰åŠ äº†æ ‡è®°ï¼Œç°åœ¨åˆ æ‰å®ƒã€‚

### ğŸ”µ Phase 3: Refactor (é‡æ„)

1. **ä¼˜åŒ–ä»£ç **:
   - æ¶ˆé™¤é‡å¤ã€‚
   - æå‡å¯è¯»æ€§ã€‚
   - ä¼˜åŒ–ç®—æ³•æ•ˆç‡ã€‚
2. **ä¿æŒæµ‹è¯•é€šè¿‡**: é‡æ„è¿‡ç¨‹ä¸­éšæ—¶è¿è¡Œæµ‹è¯•ï¼Œç¡®ä¿å®‰å…¨ç½‘æœ‰æ•ˆã€‚

---

## 2. æµ‹è¯•åˆ†å±‚ç­–ç•¥ï¼ˆç›®å½•ç»‘å®šï¼‰

| å±‚çº§ | ç›®å½• | å…³æ³¨ç‚¹ | ä¾èµ–é™åˆ¶ |
| :--- | :--- | :--- | :--- |
| **Unit (Model)** | `tests/core/models/` | ID ç”Ÿæˆã€æŒ‡é’ˆé‡è¿ã€ç®—æ³•é€»è¾‘ | **ç¦æ­¢**ä¾èµ– SceneGraph/Renderer |
| **Unit (Layout)** | `tests/core/layout/` | åæ ‡è®¡ç®—ã€é—´è·ã€é‡å æ£€æµ‹ | **ç¦æ­¢**ä¾èµ– SceneGraph/Renderer |
| **Integration (SceneGraph+Layout)** | `tests/core/test_scene_graph_flow.py` | Command -> Timeline å…¨é“¾è·¯ | å…è®¸ Model + Layout |
| **Visual** | `tests/renderers/` | Timeline -> QGraphicsScene | å…è®¸ Qt (offscreen) |
| **UI / Smoke** | `tests/ui/` | MainWindow dev hookã€èœå•è§¦å‘ | å…è®¸ QApplication |

---

## 3. TDD é€‚ç”¨æ€§ç­–ç•¥ (Strategy by Layer)

å¹¶éæ‰€æœ‰ä»£ç éƒ½é€‚åˆä¸¥æ ¼çš„ TDDã€‚ä¸ºäº†å¹³è¡¡å¼€å‘æ•ˆç‡ä¸è´¨é‡ï¼Œè¯·éµå¾ªä»¥ä¸‹ç­–ç•¥ï¼š

### æ ¸å¿ƒå¼•æ“å±‚ (Model / Layout / SceneGraph)
**ç­–ç•¥ï¼šä¸¥æ ¼ TDD (Strict TDD)**  
- å…ˆå†™æµ‹è¯•ï¼Œè¦†ç›–æˆåŠŸ/é”™è¯¯è·¯å¾„ï¼›æ–°å¢å‘½ä»¤/å¤„ç†å™¨æ—¶å¿…é¡»æœ‰è´Ÿä¾‹ã€‚

### æ¸²æŸ“å±‚ (Renderer: PySide6)
**ç­–ç•¥ï¼šå±æ€§æ–­è¨€ TDD (Property Assertion TDD)**  
- æµ‹ scene item å±æ€§ï¼ˆ`pos()`, `color`, `text`ï¼‰ï¼Œä¸åšæˆªå›¾å¯¹æ¯”ã€‚

### UI å±‚ (UI: MainWindow / Menu / Dialogs)
**ç­–ç•¥ï¼šå†’çƒŸæµ‹è¯• (Smoke Only)**  
- ç¡®ä¿å¯åŠ¨/èœå•è§¦å‘/å…³é—­æ— å´©æºƒï¼›å¤æ‚é€»è¾‘ä¸‹æ²‰åˆ° core å¯æµ‹è¯•å±‚ï¼ˆHumble Object Patternï¼‰ã€‚

---

## 4. æœ€ä½³å®è·µ (Best Practices)

### 4.1 ä½¿ç”¨ `xfail` é”å®šéœ€æ±‚
åœ¨å¼€å‘å¤æ‚åŠŸèƒ½ï¼ˆå¦‚ P0.3 çš„ ID ç¨³å®šæ€§ï¼‰æ—¶ï¼Œå…ˆå†™ä¸€ä¸ª `xfail` æµ‹è¯•æ¥å®šä¹‰â€œå®Œæˆçš„æ ‡å‡†â€ã€‚
```python
@pytest.mark.xfail(reason="P0.3: ID stability not implemented yet")
def test_ids_remain_stable_after_delete():
    # ... assertions ...
```
è¿™ç›¸å½“äºæŠŠéœ€æ±‚æ–‡æ¡£å˜æˆäº†å¯æ‰§è¡Œçš„ä»£ç ã€‚

### 4.2 é¿å… "Sleep" æµ‹è¯•
ä¸è¦åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ `time.sleep()` ç­‰å¾…åŠ¨ç”»ã€‚
- æˆ‘ä»¬çš„æ¶æ„æ˜¯åŸºäº **Timeline** çš„ã€‚
- ç›´æ¥æ–­è¨€ `timeline.steps` é‡Œçš„æ•°æ®ï¼Œæˆ–è€… `renderer` é‡Œçš„æœ€ç»ˆçŠ¶æ€ã€‚

### 4.3 Headless ä¼˜å…ˆ
æ‰€æœ‰æµ‹è¯•é»˜è®¤éƒ½åº”è¯¥èƒ½åœ¨æ— æ˜¾ç¤ºå™¨çš„ç¯å¢ƒä¸‹è¿è¡Œï¼ˆCI ç¯å¢ƒï¼‰ã€‚
- å°½é‡æ–­è¨€ `QGraphicsScene` é‡Œçš„ Item æ•°æ®ï¼Œè€Œä¸æ˜¯æˆªå›¾å¯¹æ¯”ã€‚
- é¿å…å¼¹å‡ºæ¨¡æ€å¯¹è¯æ¡†ã€‚

### 4.4 é’ˆå¯¹ CommandError çš„æµ‹è¯•
ä¸è¦åªæµ‹â€œæˆåŠŸè·¯å¾„â€ã€‚å¿…é¡»æµ‹è¯•â€œå¤±è´¥è·¯å¾„â€ï¼š
```python
def test_invalid_command_raises_error(scene_graph):
    with pytest.raises(CommandError, match="Unsupported"):
        scene_graph.apply_command(bad_cmd)
```

---

## 5. æ—¥å¸¸å·¥ä½œæ¸…å•ï¼ˆç»™æ–° Agentï¼‰
- æ”¹ä»£ç å‰ï¼šé˜…è¯» `AGENTS.md`ã€`project_state.md`ã€`docs/index.md` çš„ bound phase/versionï¼›æŸ¥ `dev_kb.md` å·²çŸ¥é—®é¢˜ã€‚
- å…ˆå†™/æ›´æ–°æµ‹è¯•ï¼šæ”¾åœ¨å¯¹åº”ç›®å½•ï¼›å¿…è¦æ—¶å…ˆæ ‡è®° `xfail`ã€‚
- è¿è¡Œæ£€æŸ¥ï¼š`uv run ruff check src tests`ã€`uv run mypy src`ã€`uv run pytest`ï¼ˆåŒ PR æ¨¡æ¿ï¼‰ã€‚
- ä¿æŒæ–‡æ¡£åŒæ­¥ï¼šæ–°å¢å‘½ä»¤/è¡Œä¸ºæ—¶æ›´æ–° registry å¯¹åº”æ–‡æ¡£ç‰ˆæœ¬ä¸å…ƒæ•°æ®ã€‚

## 6. å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
uv run pytest

# è¿è¡Œç‰¹å®šæ–‡ä»¶
uv run pytest tests/core/test_list_model.py

# è¿è¡ŒåŒ…å«ç‰¹å®šå…³é”®è¯çš„æµ‹è¯• (ä¾‹å¦‚åªæµ‹ delete)
uv run pytest -k "delete"

# é‡åˆ°ç¬¬ä¸€ä¸ªå¤±è´¥å°±åœæ­¢ (å¿«é€Ÿåé¦ˆ)
uv run pytest -x

# æ˜¾ç¤ºè¯¦ç»†è¾“å‡º (åŒ…æ‹¬ print)
uv run pytest -s
```
