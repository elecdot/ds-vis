---
bound_phase: P0.7
version: v0.8
status: Draft
last_updated: 2025-12-24
---

# ANIMATION_REQUIREMENTS — 动画要求与教学规范

## 1. 动画目标

本项目的动画服务于**教学演示**，目标是：

1. 让初学者清晰地理解每一步结构变化过程，而不仅是看到结果。
2. 为教师或学习者提供合适的讲解节奏（自动播放 / 单步 / 回看）。
3. 在不同数据结构之间保持一致的视觉语言与交互模式。

---

## 2. 动画精细度等级

定义三个精细度等级：

- **L1：结果级动画**
  - 仅在操作前后给出两个状态，使用简单过渡。
- **L2：教学级动画（本项目的默认目标）**
  - 将一个操作拆成 3–10 个“微步骤”（micro-steps）。
  - 每一步有明确的视觉焦点（高亮、移动、标注）。
- **L3：深度解剖级动画**
  - 展示内部实现细节（指针字段、平衡因子更新、内存地址等）。

本项目当前统一采用 **L2 教学级动画** 作为目标。  
L3 作为扩展方向，不纳入当前课程设计必做范围。

---

## 3. 各数据结构的 L2 动画要求（示例）

以下为 v0.2 示例，后续可根据需要细化/修改

### 3.1 顺序表（Array/List）

- **插入（位置 i）**：
  1. 高亮索引 `i` 处的格子（目标位置）。
  2. 高亮区间 `[i, size-1]` 的所有元素（待移动区间）。
  3. **平移**：区间元素整体向右滑动一个单位。
  4. **淡入**：新元素从上方飞入或在空位淡入。
  5. 更新 `size` 标注。
- **删除（位置 i）**：
  1. 高亮索引 `i` 处的元素。
  2. **淡出**：该元素消失。
  3. 高亮区间 `[i+1, size-1]`。
  4. **平移**：区间元素整体向左滑动。
  5. 更新 `size` 标注。

### 3.2 链表（Linked List）

- **插入（节点 p 后）**：
  1. **遍历**：从头节点开始，逐个高亮节点直到 `p`。
  2. **创建**：在侧边创建新节点 `x`。
  3. **连线 1**：虚线表示抓取并断开原本的`p.next`并逐渐绘制`x.next` 指向 `p.next`。
  4. **连线 2**：逐渐绘制`p.next` 指向 `x`。
  5. **重排**：调用布局引擎，使链表重新对齐。

>当前链表插入**重排**一步与**创建**同时完成

### 3.3 栈 push / pop

- **入栈**：
  1. 高亮入口位置。
  2. 元素从外部平滑移动到目标位置。
  3. 更新指针（TOP）位置。
- **出栈/出队**：
  1. 高亮待出元素。
  2. 元素向外平滑移动并淡出。
  3. 更新指针（TOP）位置。

### 3.4 BST 查找与插入

- **查找**：
  1. **比较**：高亮当前节点，显示比较气泡（如 `42 > 30`, 带颜色）。
  2. **决策**：高亮对应的子边（左或右）。
  3. **移动**：焦点移动到子节点。
- **插入**：
  1. 执行查找流程直到空位。
  2. 在空位处淡入新节点。
  3. 动画展示: 父节点链接该新节点

> **当前实现基线（P0.7）**：查找/插入的节点高亮与路径边 secondary 高亮在尾部统一恢复；消息在每步显示，收尾 CLEAR_MESSAGE；可进一步细化“比较气泡”颜色与边恢复粒度。

### 3.5 BST 删除（教学化难点）

- **叶子节点**：直接淡出节点及父边。
- **单子树**：
  1. 高亮待删节点 D 及其唯一子节点 C。
  2. **接管**：D的父节点指针（即边）直接指向 C。
  3. D（及其其连接子节点 C 的边）淡出，C 及其子树平滑移动到 D 的原位置。
- **双子树（后继替换法）**：
  1. 高亮待删节点 D。
  2. **寻找后继**：高亮 D 的右子树，并沿左路径逐个找到最小节点 S。
  3. **值复制**：将 S 的值“飞向” D（更新 D 的标签）。
  4. **删除后继**：高亮 S，按“叶子”或“单子树”情况删除 S。
  
> **当前实现基线（P0.7）**：已落地后继替换法，支持后继带右子；删除阶段包含边重连/删除与节点删除，统一 Restore 状态；后继遍历的恢复/分步消息仍可细化。

### 3.6 AVL 旋转（重点在 Model -- Layout Engine 的配合）

- 显示平衡因子气泡
- 显示当前旋转类型
  - **单旋（LL/RR）**：
    1. 高亮失衡节点 A、子节点 B。
    2. **重心转换**：B 向上移动，A 向下并向侧边移动。
    3. **子树挂接**：若 B 有内侧子树，动画演示其断开并挂接到 A。
  - **双旋（LR/RL）**：
  1. 分为两次单旋，中间停顿并显示“中间状态”。
- 更新平衡因子气泡

### 3.7 哈夫曼树构建

1. 按大小顺序排列所有候选节点
2. 对每一步合并：
  - 高亮权值最小的两节点（即前两个）。
  - 聚焦两个子节点并向上“汇聚”（边动画）到一个淡入的新父节点。
  - 将父加入（平移至）候选节点排列（以父节点为根的树一同移动）
3. 哈夫曼树构建完成后全体节点闪烁一次。

### 3.8 Git 教学操作动画（新增）

本项目支持展示 Git 内部数据结构在一组虚拟操作下的变化过程，用于教学目的。
所有动画遵循 L2 教学级要求，将 Git 命令拆解为若干 micro-steps。
这里只做文字叙述，应在实现是根据当时具体的 Renderer 的实现情况考虑最优
的实现方案。

#### git init
1. 创建一个空 DAG 区域。
2. 创建 main 分支引用（branch label）。
3. HEAD 指向 main。

#### git commit -m "<msg>"
1. 高亮 HEAD 指向的 commit（空仓库时的 main 或不高亮）。
2. 在同一 lane 上方生成新 commit 节点。
3. 动画绘制从父 commit 到新 commit 的边。
4. 将 branch label 移动到新 commit。
5. 将 HEAD 移动到 branch label。

#### git branch <name>
1. 高亮 HEAD 所在 commit。
2. 在该 commit 旁展示新分支 label。
3. 加入提示文字：“branch <name> 指向当前提交”。

#### git checkout <branch>
1. 高亮当前 HEAD 与目标分支 label。
2. 将 HEAD label 从原分支移动到目标分支。
3. 高亮目标 commit。
4. 若进入 detached 状态：
   - 直接将 HEAD 指向 commit 节点。
   - 显示提示：“detached HEAD”。

#### git merge <branch>（简化无冲突版本）
1. 高亮当前分支 HEAD。
2. 高亮待合并分支 HEAD。
3. 生成 merge commit 节点（两个 parent edge）。
4. 当前 branch label 与 HEAD 共同移动到 merge commit。
5. 加入提示文字：“merge commit（简化版）”。

---

## 4. 视觉、状态与交互统一规范

### 4.1 状态值与颜色（推荐表）

| State       | 用途示例                          | 默认颜色（RendererConfig） |
| ----------- | --------------------------------- | ------------------------- |
| normal      | 默认状态                          | `#6b7280`                 |
| active      | 当前操作焦点                      | `#2563eb`                 |
| highlight   | 关键节点/新边强调                 | `#f59e0b`                 |
| secondary   | 遍历路径、辅助高亮                | `#059669`                 |
| to_delete   | 将被替换/删除的元素（旧边等）    | `#dc2626`                 |
| faded       | 弱化/降权显示                     | `#9ca3af`                 |
| error       | 错误提示                          | `#f97316`                 |

说明：状态字符串可扩展，RendererConfig 可覆写颜色；新模型应复用上述语义，避免自定义散乱命名。

### 4.2 动画时间与控制

- 单个 micro-step 动画时长建议在 **300–600 ms**。
- 全局速度因子：0.5x / 1x / 2x（当前 PySide6Renderer 同步阻塞插值）。
- 播放控制：Play / Pause / Step / 重置；seek/skip/非阻塞为后续方向（占位）。
- max_frames/easing：RendererConfig 提供占位参数（默认 10 帧、线性），行为与旧版一致。

### 4.3 文本与辅助提示（消息策略）

- 使用 `SET_MESSAGE` / `CLEAR_MESSAGE` 显示 HUD 文本；当前 PySide6Renderer 将消息锚定到场景 bbox 顶部居中（避免与结构过远），可根据结构 bbox 再细化。
- RendererConfig `show_messages` 可禁用消息渲染；锚定节点/富提示为未来扩展。
- 推荐：在操作开始/结果时提供简短提示，避免每步频繁刷屏；完成后务必 CLEAR_MESSAGE。

### 4.4 节点与边的视觉风格

- 顺序表/栈：矩形块；链表：值+next 区域；树节点：圆/圆角矩形；Git 节点：小圆点+标签。
- 当前焦点用 active/highlight；待替换/删除用 to_delete。
- 形状/尺寸由 RendererConfig 决定，缺省保持现有视觉；与 Layout 的尺寸/间距联动为后续优化。

---

## 5. 与 AnimationOps 的关系

本文件描述的是"**动画应该展示什么**"的教学需求层面。
在实现时：

- Model 与 SceneGraph 应根据这些要求，将一个高层操作拆成若干 AnimationOps 序列，并组织为 Timeline。
- AnimationOps 和 Timeline 的具体类型与字段定义在 `ops_spec.md` 中。
- Renderer（PySide6/Web）负责：
  - 接收 Timeline，按 Step 顺序播放
  - 在每个 Step 的 `duration_ms` 时间内，从当前可视状态过渡到应用所有 Ops 后的终态
  - 不重新决定教学粒度与流程，仅负责具体的渲染与动画实现

**如果现有的 AnimationOps 定义不足以支撑目前的动画要求，应该经过谨慎考虑后扩展**

---

## 6. 当前实现基线（P0.6）

- 播放粒度：仍以 Step 为单位，不支持 seek/倒播/skip。
- 动画实现：PySide6 renderer 基于 `duration_ms` 做同步插值（线性），CREATE/DELETE 淡入淡出，`SET_POS`/`SET_STATE` 线性过渡，帧数最多 10 帧；可全局开关、速度倍率（0.5/1/2）。
- 限制：动画为阻塞式（使用 qWait），长时长或大量节点可能卡 UI；无自定义缓动、无异步调度。
- UI 控件：Dev 播放控制 Play/Pause/Step/Speed 与动画开关，单场景演示用，不含 seek/多时间线管理。

> 交叉引用：`kind` 的语义类型与 Style/Metrics 的注入约束请参见 `docs/design/architecture.md` 第 6.3 节。

---

## 7. 已知缺口（P0.6）

- **Model**：链表插入缺少“从头节点遍历到目标位置”的高亮/熄灭循环步骤（需补 L2 traversal）。
- **Renderer**：边动画缺失（仅支持边创建与状态色变化）；未实现“逐渐绘制/虚线抓取/删除边”的表现。
- **Layout**：节点“侧边悬停/从上方入场”的位置预留未实现。该需求标记为**低优先级**，且应在 Layout 层实现，避免 Renderer 通过私有位移规则引入隐式耦合。
